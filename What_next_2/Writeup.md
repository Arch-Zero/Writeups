### MAPNA CTF 2024

## Challenge Premise

The flag has been hidden by xoring it with a key.
The key was created using the random module in python, by taking the sum of 8 random 256-bit numbers that have their bits shifted to the right.

```py
 #!/usr/bin/env python3

from random import *
from Crypto.Util.number import *
from flag import flag

def encrypt(msg, KEY):
	m = bytes_to_long(msg)
	c = KEY ^ m
	return c

n = 80
TMP = [getrandbits(256) * _ ** 2 for _ in range(n)]
KEY = sum([getrandbits(256 >> _) ** 2 for _ in range(8)]) 

enc = encrypt(flag, KEY)

print(f'TMP = {TMP}')
print(f'enc = {enc}')`

```
## The Vulnerability

If the numbers were truly random, then the challenge would be much harder. But in python, the random module generates pseudo-random numbers using algorithms. The algorithms use a starting point called a seed, and from that seed, a sequence of numbers is produced. If you provide the same seed, you'll get the same sequence of numbers.
Mersenne Twiser is an algorithm that uses Mersenne Primes (2^n - 1) to create numbers that are statistically random and approved however they are not cryptographically secure.

## The Solution

Finding the Seed will help us predict the next pseudo random number, we can do this by using any random number cracker modules like randcrack.
I'll be using Extend MT19937 Predictor.
We require 624 * 32 bit numbers to be able to predict the next and we have 80 * 256- bit numbers which is just more than what we need.
But first we reverse the encryption of temp.

```py
temp = []

for i in range(80):
    if i == 0:
        continue
    k = int(TMP[i]) // (i ** 2)
    temp.append(k)
```

So now we have the 80 original pseudo random numbers generated by the random module. We need to feed this into MT19937 Predictor.

```py
mt = ExtendMT19937Predictor()

for j in range(len(temp)):
    mt.setrandbits(temp[j], 256)

key  = sum([mt.predict_getrandbits(256 >> _) ** 2 for _ in range(8)])
flag = (long_to_bytes(key ^ enc))
print(flag.decode())
```

And we get the flag
```
Flag : MAPNA{4Re_y0U_MT19937_PRNG_pr3d!cT0r_R3ven9E_4057950503c1e3992}
```
